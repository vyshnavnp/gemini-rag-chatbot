deploy:
    name: Deploy to EC2
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Copy docker-compose.yml to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "docker-compose.yml"
        target: "/home/ubuntu/"

    - name: SSH into EC2 and Deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        envs: AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_REGION,ECR_REGISTRY,ECR_REPOSITORY,GEMINI_API_KEY
        script: |
          # --- FIX: Tell the script where to find Snap apps (AWS CLI) ---
          export PATH=$PATH:/snap/bin

          # 1. Export Env Vars for Docker Compose
          export ECR_REGISTRY=${{ secrets.ECR_REGISTRY }}
          export ECR_REPOSITORY=${{ secrets.ECR_REPOSITORY }}
          export GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          export AWS_DEFAULT_REGION=${{ secrets.AWS_REGION }}
          export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}

          # 2. Login to ECR
          # We use the full path to 'aws' just to be 100% sure
          aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

          # 3. Ensure Directory Structure Exists
          mkdir -p oncobot_data/knowledge_base
          mkdir -p oncobot_data/chroma_db

          # 4. Pull Latest Image
          docker compose pull

          # 5. Restart Services
          docker compose up -d